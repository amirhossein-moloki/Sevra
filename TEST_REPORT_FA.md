# گزارش وضعیت تست‌های پروژه Sevara

## خلاصه نتایج
- **کل فایل‌های تست (Suites):** ۲۶
- **فایل‌های موفق:** ۱۴
- **فایل‌های ناموفق:** ۱۲
- **کل تست‌ها:** ۱۳۶
- **تست‌های موفق:** ۸۶
- **تست‌های ناموفق:** ۴۹
- **تست‌های نادیده گرفته شده:** ۱

---

## تحلیل خطاها
بخش بزرگی از تست‌های ناموفق (تقریباً تمامی موارد مربوط به فایل‌های `.routes.test.ts` و فایل‌های امنیتی) به دلیل عدم اتصال به پایگاه داده با خطای زیر مواجه شده‌اند:
`PrismaClientInitializationError: Can't reach database server at localhost:5432`

**تلاش برای رفع خطا با داکر:**
تلاش مجددی برای اجرای پایگاه داده با استفاده از Docker Compose انجام شد، اما با خطای سیستمی زیر متوقف گردید:
`failed to extract layer ... failed to convert whiteout file ... operation not permitted`

این خطا نشان‌دهنده محدودیت‌های سطح دسترسی در لایه‌های فایل‌سیستم محیط فعلی (Sandbox) برای اجرای Docker-in-Docker است. بنابراین، امکان اجرای تست‌هایی که به پایگاه داده واقعی نیاز دارند در این محیط وجود ندارد. با این حال، ۸۶ تست واحد (Unit Tests) که از Mock استفاده می‌کردند با موفقیت پاس شدند.

---

## وضعیت ماژول‌ها

### ماژول‌های با تست‌های موفق (Pass):
۱. **Users Service:** تست‌های منطق کسب‌وکار کاربران.
۲. **Commissions Service:** محاسبه پورسانت‌ها.
۳. **Salon Service:** مدیریت سالن‌ها.
۴. **CMS Validators:** اعتبارسنجی صفحات.
۵. **Availability Logic:** منطق پیچیده محاسبه زمان‌های آزاد (بدون وابستگی به DB).
۶. **Public Page Renderer:** رندر کردن صفحات عمومی.
۷. **Webhooks Service:** مدیریت وب‌هوک‌ها.
۸. **Auth Service:** منطق احراز هویت.
۹. **Analytics Service:** سرویس تحلیل داده.
۱۰. **Shifts Service:** مدیریت شیفت‌ها.
۱۱. **Audit Service:** ثبت گزارشات تغییرات (Audit Logs).
۱۲. **Swagger/Docs:** صحت مستندات API.

### ماژول‌های با تست‌های ناموفق (Fail):
اکثر این موارد به دلیل نیاز به دیتابیس واقعی برای تست‌های Integration و E2E شکست خورده‌اند:
- **Availability Routes:** تست‌های API مربوط به نوبت‌دهی.
- **Auth Routes:** تست‌های ورود و خروج و OTP.
- **Security & RBAC:** تست‌های مربوط به سطوح دسترسی و جداسازی مستاجران (Tenant Isolation).
- **Services Routes & Service:** مدیریت خدمات سالن.
- **Payments Idempotency:** بررسی جلوگیری از تراکنش‌های تکراری.
- **Logger Middleware:** یک مورد خطا در انتظارات Mock و Timeout.

---

## ارزیابی فنی و پیشنهادات
۱. **پوشش تست:** پروژه دارای پوشش تست خوبی در لایه Service است.
۲. **وابستگی به دیتابیس:** بسیاری از تست‌هایی که به عنوان تست واحد شناخته می‌شوند، عملاً وابستگی مستقیم به دیتابیس دارند. پیشنهاد می‌شود برای تست‌های واحد واقعی، لایه Repository به طور کامل Mock شود.
۳. **زیرساخت تست:** برای اجرای کامل تست‌ها، محیط باید امکان اجرای Docker یا دسترسی به یک دیتابیس آزمایشی را داشته باشد.

---

## اقدامات بعدی
- بررسی دقیق‌تر خطای `Logger Middleware` که صرفاً مربوط به دیتابیس نبود.
- بهبود فرآیند Mocking در تست‌های لایه Service برای کاهش وابستگی به دیتابیس در تست‌های واحد.
- مستندسازی نیازمندی‌های محیطی برای اجرای موفق تست‌ها (Docker/Postgres).
