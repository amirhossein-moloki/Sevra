# تشریح کامل ماژول سرویس‌ها (Services Module)

این مستند به بررسی کامل معماری و منطق ماژول سرویس‌ها در پروژه Sevra می‌پردازد. این ماژول به عنوان یک نمونه پیاده‌سازی کامل و استاندارد در پروژه طراحی شده است.

## ساختار ماژول

معماری این ماژول به صورت لایه‌ای طراحی شده تا تفکیک مسئولیت‌ها (Separation of Concerns) به خوبی رعایت شود:

1.  **Routes**: تعریف اند‌پوینت‌های HTTP.
2.  **Controllers**: مدیریت درخواست و پاسخ HTTP.
3.  **Services**: پیاده‌سازی منطق بیزینسی (Business Logic).
4.  **Repositories**: دسترسی به دیتابیس (Data Access Layer).
5.  **Validators**: اعتبارسنجی داده‌های ورودی.

---

### ۱. اند‌پوینت‌ها (Endpoints)

**فایل:** `src/modules/services/services.routes.ts`

این فایل مسیرهای API مربوط به ماژول سرویس‌ها را تعریف می‌کند.

| Method | URL                                         | توضیحات                                       |
| :----- | :------------------------------------------ | :--------------------------------------------- |
| `POST` | `/salons/:salonId/services`                 | یک سرویس جدید برای سالن مشخص شده ایجاد می‌کند. |
| `GET`  | `/salons/:salonId/services`                 | لیست تمام سرویس‌های یک سالن را برمی‌گرداند.    |
| `GET`  | `/services/:serviceId`                      | اطلاعات یک سرویس خاص را با ID آن برمی‌گرداند.   |
| `PATCH`| `/services/:serviceId`                      | اطلاعات یک سرویس خاص را آپدیت می‌کند.          |
| `DELETE`| `/services/:serviceId`                     | یک سرویس را غیرفعال (soft delete) می‌کند.      |

**نکته:** این مسیرها باید توسط میان‌افزارهای `auth` و `tenantGuard` محافظت شوند که در حال حاضر پیاده‌سازی نشده‌اند.

---

### ۲. کنترلرها (Controllers)

**فایل:** `src/modules/services/services.controller.ts`

کنترلرها به عنوان یک واسط بین درخواست‌های HTTP و منطق بیزینسی عمل می‌کنند. آن‌ها داده‌ها را از `req` (request) استخراج کرده و به لایه سرویس ارسال می‌کنند و در نهایت پاسخ مناسب را به کاربر (`res`) برمی‌گردانند.

-   `createServiceHandler`: داده‌ها را از `req.params` و `req.body` گرفته و تابع `createService` را فراخوانی می‌کند.
-   `getServicesHandler`: پارامترهای URL و کوئری را گرفته و تابع `getServicesForSalon` را فراخوانی می‌کند.
-   سایر کنترلرها نیز به همین ترتیب توابع متناظر در لایه سرویس را فراخوانی می‌کنند.

---

### ۳. منطق بیزینسی (Business Logic)

**فایل:** `src/modules/services/services.service.ts`

این لایه قلب ماژول است و قوانین اصلی بیزینس در آن پیاده‌سازی می‌شود. این لایه هیچ وابستگی مستقیمی به پروتکل HTTP ندارد.

-   `createService(salonId, data)`: اطلاعات را برای ایجاد سرویس به لایه ریپازیتوری ارسال می‌کند. در آینده می‌توان منطق‌های پیچیده‌تر (مانند بررسی نام تکراری) را در این بخش اضافه کرد.
-   `getServiceById(serviceId)`: یک سرویس را از ریپازیتوری دریافت می‌کند. **منطق کلیدی** در این تابع، بررسی وجود سرویس است؛ اگر سرویس پیدا نشود، یک خطای `404 Not Found` ایجاد می‌کند.
-   `updateService(serviceId, data)`: قبل از به‌روزرسانی، با استفاده از `getServiceById` از وجود سرویس اطمینان حاصل می‌کند. این یک نمونه خوب از استفاده مجدد از کد است.
-   `deactivateService(serviceId)`: مانند آپدیت، ابتدا وجود سرویس را بررسی کرده و سپس آن را غیرفعال می‌کند.

---

### ۴. دسترسی به دیتابیس (Repository)

**فایل:** `src/modules/services/services.repo.ts`

این لایه تنها بخشی است که مستقیماً با دیتابیس (از طریق Prisma) تعامل دارد. وظیفه آن اجرای کوئری‌های CRUD و تبدیل داده‌هاست.

-   `createService(...)`: با استفاده از `prisma.service.create` یک رکورد جدید در دیتابیس ایجاد می‌کند.
-   `findServiceById(...)`: با `prisma.service.findUnique` یک سرویس را بر اساس ID پیدا می‌کند.
-   `findServicesBySalonId(...)`: با `prisma.service.findMany` تمام سرویس‌های یک سالن را پیدا می‌کند.
-   `updateService(...)`: با `prisma.service.update` یک رکورد را به‌روزرسانی می‌کند.
-   `deactivateService(...)`: یک نمونه از **soft delete** است. به جای حذف کامل، فیلد `isActive` را به `false` تغییر می‌دهد تا سوابق حفظ شوند.

---

### ۵. اعتبارسنجی (Validation)

**فایل:** `src/modules/services/services.validators.ts`

با استفاده از کتابخانه `Zod`، قوانینی برای داده‌های ورودی (Payload) تعریف می‌شود تا از صحت و سلامت آن‌ها قبل از پردازش اطمینان حاصل شود.

-   `createServiceSchema`: قوانینی مانند نوع داده (رشته، عدد)، حداقل طول و مثبت بودن اعداد را برای ایجاد سرویس جدید تعریف می‌کند.
-   `updateServiceSchema`: مشابه اسکیمای ایجاد است، با این تفاوت که تمام فیلدها `optional` هستند تا کاربر بتواند فقط فیلدهای مورد نظر خود را به‌روزرسانی کند.

این اسکماها در لایه `Route` توسط یک میان‌افزار اعتبارسنجی (که هنوز پیاده‌سازی نشده) استفاده می‌شوند.
