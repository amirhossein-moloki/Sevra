
# مشخصات فنی و تحلیل پروژه سامانه مدیریت سالن (Sevra)
**نسخه ۱.۰**

---

## مقدمه
این سند به منظور تشریح و مستندسازی کلیه خدمات، امکانات، فناوری‌ها و خروجی‌های فنی پروژه نرم‌افزاری **"سامانه مدیریت سالن (Sevra)"** تدوین گردیده است. هدف از ارائه این مستند، ایجاد درک مشترک، شفاف و دقیق از محدوده پروژه (Scope of Work) جهت الصاق به قرارداد رسمی و تسهیل فرآیند تحویل پروژه می‌باشد. محتوای این سند بر اساس تحلیل جامع کد منبع، معماری سیستم و مدل داده موجود تهیه شده است.

---

### ۱. معرفی کلی پروژه
#### ۱.۱. هدف پروژه
هدف اصلی این پروژه، توسعه یک سامانه نرم‌افزاری یکپارچه، چندمستأجری (Multi-tenant) و API-محور برای مدیریت هوشمند و آنلاین سالن‌های زیبایی است. این سیستم به مدیران سالن‌ها امکان می‌دهد تا کلیه فرآیندهای داخلی خود از جمله مدیریت کارکنان، خدمات، رزروها، مشتریان و پرداخت‌ها را به صورت متمرکز مدیریت نمایند. همچنین، این پلتفرم قابلیت ایجاد یک وب‌سایت عمومی برای هر سالن را فراهم می‌آورد تا مشتریان نهایی بتوانند خدمات را مشاهده، بررسی و رزرو نمایند.

#### ۱.۲. نوع سیستم
این پروژه یک سیستم **بک‌اند (Backend)** است که منطق تجاری و مدیریت داده‌ها را بر عهده دارد. کلیه خدمات و قابلیت‌های سیستم از طریق مجموعه‌ای از **APIهای استاندارد (API-Driven)** ارائه می‌شود که امکان اتصال و استفاده توسط کلاینت‌های مختلف (مانند اپلیکیشن‌های وب، موبایل و دسکتاپ) را فراهم می‌سازد. ماهیت اصلی سیستم، **فروشگاهی و خدماتی** بوده و بر مدیریت و فروش خدمات تمرکز دارد.

---

### ۲. فناوری‌ها و ابزارهای استفاده‌شده
این پروژه با بهره‌گیری از فناوری‌های مدرن و پایدار توسعه یافته است تا از عملکرد، امنیت و مقیاس‌پذیری بالایی برخوردار باشد.
- **زبان برنامه‌نویسی:** TypeScript (نسخه ۵.x)
- **محیط اجرایی (Runtime):** Node.js
- **فریم‌ورک اصلی بک‌اند:** Express.js
- **پایگاه داده:** PostgreSQL
- **ORM (Object-Relational Mapping):** Prisma
- **احراز هویت:** مبتنی بر توکن (JWT - JSON Web Token) و مدیریت نشست (Session)
- **مستندسازی API:** طراحی‌شده برای تولید مستندات از طریق ابزارهایی مانند Swagger/OpenAPI (نیازمند پیاده‌سازی لایه API)
- **اعتبارسنجی داده‌ها:** Zod
- **ابزارهای جانبی:**
  - **Argon2:** برای هشینگ امن رمزهای عبور
  - **Pino:** برای لاگ‌گیری (Logging) ساختاریافته
  - **Helmet:** برای افزایش امنیت هدرهای HTTP
  - **CORS:** برای مدیریت دسترسی‌های Cross-Origin
  - **Day.js:** برای مدیریت تاریخ و زمان

---

### ۳. ماژول‌ها و قابلیت‌های طراحی‌شده
سیستم بر اساس یک معماری ماژولار طراحی شده است که هر ماژول مسئولیت یک بخش از منطق تجاری را بر عهده دارد. در ادامه، قابلیت‌های اصلی هر ماژول که زیرساخت آن در سیستم تعبیه شده است، تشریح می‌شود.

#### ۳.۱. مدیریت سالن‌ها (Salons)
- **چندمستأجری:** قابلیت تعریف و مدیریت چندین سالن به صورت کاملاً ایزوله در یک سیستم واحد.
- **پروفایل عمومی:** امکان تعریف اطلاعات عمومی برای هر سالن (نام، اسلاگ منحصر به فرد برای URL، توضیحات) جهت استفاده در وب‌سایت عمومی.
- **تنظیمات سئو (SEO):** قابلیت مدیریت عنوان و توضیحات سئو برای هر سالن.

#### ۳.۲. مدیریت کاربران و احراز هویت (Users & Auth)
- **نقش‌های کاربری:** تعریف کاربران با سه نقش اصلی: `MANAGER`, `RECEPTIONIST`, `STAFF`.
- **احراز هویت امن:** فرآیند ثبت‌نام و ورود کاربران با استفاده از رمز عبور هش‌شده (Argon2).
- **مدیریت نشست (Session):** ایجاد و ابطال نشست‌های کاربری از طریق توکن‌های امن.
- **پروفایل کارکنان:** امکان تعریف پروفایل برای هر یک از کارکنان، شامل اطلاعات عمومی و قابلیت نمایش در وب‌سایت.

#### ۳.۳. مدیریت مشتریان (Customers)
- **حساب کاربری یکپارچه مشتری:** مشتریان می‌توانند یک حساب کاربری سراسری داشته باشند و در سالن‌های مختلف پروفایل مجزا ایجاد کنند.
- **پروفایل مشتری در هر سالن:** امکان ثبت اطلاعات و یادداشت‌های مخصوص هر مشتری برای هر سالن به صورت جداگانه.

#### ۳.۴. مدیریت خدمات (Services)
- **تعریف خدمات:** امکان تعریف خدمات مختلف با جزئیاتی مانند نام، مدت زمان اجرا (به دقیقه)، قیمت و واحد پول.
- **تخصیص خدمات به کارکنان:** قابلیت مشخص کردن اینکه کدام یک از کارکنان کدام خدمات را ارائه می‌دهند.

#### ۳.۵. مدیریت شیفت‌ها و ساعات کاری (Shifts)
- **تعریف شیفت‌های کاری:** امکان تعریف ساعات کاری برای هر یک از کارکنان در روزهای مختلف هفته.
- **سیستم مدیریت در دسترس بودن:** این ماژول زیربنای اصلی سیستم رزرو آنلاین برای بررسی ظرفیت خالی کارکنان است.

#### ۳.۶. مدیریت رزروها (Bookings)
- **ایجاد رزرو:** قابلیت ثبت رزرو برای یک مشتری، خدمت و کارمند مشخص در زمان معین.
- **وضعیت‌های رزرو:** چرخه کامل وضعیت یک رزرو شامل `PENDING`, `CONFIRMED`, `DONE`, `CANCELED`, `NO_SHOW`.
- **منبع رزرو:** تفکیک رزروهای ثبت‌شده به صورت حضوری (`IN_PERSON`) یا آنلاین (`ONLINE`).
- **تاریخچه (Snapshot):** ذخیره‌سازی اطلاعات کلیدی خدمت (نام، قیمت، مدت) در لحظه رزرو جهت جلوگیری از بروز مشکل در صورت تغییر قیمت‌ها.

#### ۳.۷. مدیریت پرداخت‌ها (Payments)
- **ثبت پرداخت:** امکان ثبت پرداخت‌های مرتبط با یک رزرو.
- **وضعیت‌های پرداخت:** مدیریت وضعیت پرداخت شامل `PENDING`, `PAID`, `FAILED`, `REFUNDED`.
- **روش‌های پرداخت:** پشتیبانی از روش‌های پرداخت نقدی (`CASH`)، کارت (`CARD`) و آنلاین (`ONLINE`).

#### ۳.۸. سیستم مدیریت محتوا (CMS) و وب‌سایت
- **صفحه‌ساز:** قابلیت ایجاد و مدیریت صفحات مختلف (خانه، درباره ما، خدمات و...) برای وب‌سایت هر سالن.
- **بخش‌های صفحه (Sections):** امکان چینش بخش‌های مختلف محتوایی در هر صفحه (مانند هیرو، گالری، تیم ما، تماس با ما).
- **مدیریت رسانه:** آپلود و مدیریت تصاویر و ویدئوها برای استفاده در وب‌سایت.
- **تنظیمات عمومی سایت:** مدیریت لوگو، فاویکون و تنظیمات پیش‌فرض سئو.
- **مدیریت آدرس و لینک‌ها:** امکان ثبت آدرس‌های فیزیکی و لینک‌های شبکه‌های اجتماعی.

#### ۳.۹. مدیریت نظرات (Reviews)
- **ثبت نظر:** مشتریان می‌توانند برای سالن یا خدمات دریافت‌شده نظر و امتیاز ثبت کنند.
- **مدیریت نظرات:** امکان مدیریت و کنترل نمایش نظرات ثبت‌شده.

#### ۳.۱۰. مدیریت کمیسیون (Commissions)
- **تعریف سیاست کمیسیون:** قابلیت تعریف سیاست کمیسیون (درصدی یا ثابت) برای رزروهای آنلاین.
- **محاسبه خودکار:** محاسبه کمیسیون برای رزروهای واجد شرایط.
- **مدیریت پرداخت کمیسیون:** امکان ثبت و پیگیری پرداخت‌های مربوط به کمیسیون.

---

### ۴. APIها و خروجی‌های فنی (طراحی پیشنهادی)
با توجه به عدم پیاده‌سازی لایه API، در این بخش **طراحی پیشنهادی** برای APIها بر اساس معماری پروژه ارائه می‌شود.
- **نوع API:** RESTful API
- **فرمت داده:** JSON

#### ۴.۱. معماری API
APIها به دو بخش اصلی تقسیم می‌شوند:
1.  **Panel API (خصوصی):** این APIها برای استفاده در پنل مدیریت سالن طراحی شده‌اند و نیازمند احراز هویت هستند. دسترسی به منابع از طریق `salonId` انجام می‌شود.
    - **الگوی URL:** `/api/v1/salons/{salonId}/...`
2.  **Public API (عمومی):** این APIها برای وب‌سایت عمومی هر سالن استفاده می‌شوند و عمدتاً برای نمایش اطلاعات (Read-only) به کار می‌روند. دسترسی به منابع از طریق `salonSlug` انجام می‌شود.
    - **الگوی URL:** `/api/v1/public/salons/{salonSlug}/...`

#### ۴.۲. ساختار کلی پاسخ‌ها
پاسخ‌های API از یک ساختار استاندارد پیروی خواهند کرد:
```json
{
  "success": true,
  "data": { ... }, // یا [...] برای لیست‌ها
  "message": "عملیات با موفقیت انجام شد"
}
```
در صورت بروز خطا، ساختار پاسخ به شکل زیر خواهد بود:
```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "پیام خطا"
  }
}
```

#### ۴.۳. مستندسازی API
پیشنهاد می‌شود پس از پیاده‌سازی، مستندات کامل API با استفاده از استاندارد **OpenAPI 3.0** و ابزار **Swagger UI** تولید و ارائه گردد.

---

### ۵. دیتابیس و ساختار داده
- **موجودیت‌های اصلی (Models):** `Salon`, `User`, `CustomerAccount`, `Service`, `Shift`, `Booking`, `Payment`, `Review`, `SalonPage` و سایر مدل‌های تعریف‌شده در فایل `prisma/schema.prisma`.
- **روابط بین آن‌ها:**
  - یک `Salon` می‌تواند چندین `User` (کارمند)، `Service` و `Booking` داشته باشد.
  - یک `Booking` به یک `Service`، یک `User` (به عنوان کارمند) و یک `CustomerAccount` مرتبط است.
  - روابط به صورت کامل و دقیق در فایل `prisma/schema.prisma` با استفاده از کلیدهای خارجی و ایندکس‌ها تعریف شده‌اند.
- **نکات مهم در طراحی دیتابیس:**
  - **چندمستأجری (Multi-tenancy):** تمامی مدل‌های اصلی دارای یک `salonId` هستند تا از ایزوله بودن داده‌های هر سالن اطمینان حاصل شود.
  - **ایندکس‌گذاری:** ایندکس‌های مناسبی بر روی فیلدهای پرکاربرد (مانند `slug`, `status`, `startAt`) تعریف شده است تا کارایی کوئری‌ها افزایش یابد.
  - **حذف آبشاری (Cascade Deletes):** در روابط حساس (مانند حذف کاربر و نشست‌های مرتبط با او)، از حذف آبشاری برای حفظ یکپارچگی داده‌ها استفاده شده است.

---

### ۶. امنیت و کنترل دسترسی
- **احراز هویت:** از طریق ماژول `Auth` و با استفاده از توکن‌های مبتنی بر نشست (Session-based tokens) انجام می‌شود. رمزهای عبور با الگوریتم امن Argon2 هش می‌شوند.
- **مجوزها و سطح دسترسی (Authorization):**
  - دسترسی به APIهای پنل مدیریت (`/api/v1/salons/{salonId}/...`) نیازمند احراز هویت است.
  - پس از احراز هویت، سیستم باید بررسی کند که کاربر واردشده به `salonId` مشخص‌شده در URL دسترسی دارد.
  - منطق کنترل دسترسی بر اساس نقش کاربر (`UserRole`) باید در لایه سرویس هر ماژول پیاده‌سازی شود تا اطمینان حاصل شود که برای مثال، یک کارمند (`STAFF`) نمی‌تواند به تنظیمات سالن دسترسی داشته باشد.
- **نکات امنیتی رعایت‌شده در زیرساخت:**
  - استفاده از `Helmet` برای محافظت در برابر آسیب‌پذیری‌های رایج وب.
  - استفاده از `rate-limiter-flexible` برای جلوگیری از حملات Brute-force.
  - اعتبارسنجی دقیق داده‌های ورودی با `Zod` برای جلوگیری از حملات Injection.

---

### ۷. تست، کیفیت و پایداری
- **تست‌های انجام‌شده:** در حال حاضر، اسکریپت تست در پروژه (`"test": "echo \"Error: no test specified\" && exit 1"`) یک Placeholder است. پیشنهاد می‌شود تست‌های واحد (Unit Tests) و تست‌های یکپارچه‌سازی (Integration Tests) با استفاده از فریم‌ورک `Jest` و `Supertest` برای تمام APIها و سرویس‌ها نوشته شود.
- **مدیریت خطاها:** پروژه از پکیج `express-async-errors` و یک میان‌افزار (Middleware) مدیریت خطای مرکزی بهره می‌برد. این ساختار تضمین می‌کند که خطاهای پیش‌بینی‌نشده در برنامه به صورت کنترل‌شده مدیریت شده و از کرش کردن سرور جلوگیری می‌شود.
- **لاگ‌ها (Logging):** با استفاده از `pino` و `pino-http`، کلیه درخواست‌ها و رخدادهای مهم سیستم به صورت ساختاریافته لاگ می‌شوند که برای اشکال‌زدایی (Debugging) و مانیتورینگ بسیار حیاتی است.

---

### ۸. نحوه تحویل پروژه
- **روش تحویل سورس کد:** سورس کد کامل پروژه از طریق یک ریپازیتوری Git (مانند GitHub یا GitLab) به کارفرما تحویل داده خواهد شد.
- **مستندات تحویلی:**
  1.  این سند (مشخصات فنی و تحلیل پروژه).
  2.  مستندات API (پس از پیاده‌سازی) در قالب Swagger/OpenAPI.
  3.  یک فایل `README.md` کامل که شامل راهنمای راه‌اندازی و اجرای پروژه در محیط توسعه (Development) و تولید (Production) باشد.
  4.  مجموعه Postman Collection برای تست دستی APIها.
- **راه‌اندازی و اجرای پروژه:** پروژه به همراه یک فایل `docker-compose.yml` ارائه می‌شود که راه‌اندازی پایگاه داده PostgreSQL و خود برنامه را تسهیل می‌کند. دستورالعمل‌های دقیق برای اجرای پروژه در فایل `README.md` ارائه خواهد شد.

---

### ۹. موارد خارج از محدوده پروژه (Out of Scope)
قابلیت‌های زیر در تحلیل فعلی شناسایی نشده و پیاده‌سازی آن‌ها نیازمند بررسی و توافق مجزا می‌باشد:
- سیستم مدیریت انبار محصولات فیزیکی.
- درگاه پرداخت آنلاین ایرانی (نیازمند پیاده‌سازی ماژول اختصاصی).
- سیستم ارسال پیامک (SMS) برای یادآوری رزروها.
- اپلیکیشن موبایل برای مشتریان یا مدیران.
- بخش حسابداری پیشرفته و گزارش‌گیری‌های مالی پیچیده.

---

### ۱۰. جمع‌بندی نهایی
- **نتیجه پروژه:** پروژه "سامانه مدیریت سالن (Sevra)" دارای یک زیرساخت و معماری بسیار قوی، مدرن و مقیاس‌پذیر است. مدل داده جامع و ماژول‌های خوش‌تعریف، پتانسیل بالایی برای تبدیل شدن به یک پلتفرم SaaS کامل را فراهم کرده‌اند.
- **آمادگی برای توسعه‌های آینده:** در مرحله فعلی، زیرساخت و منطق تجاری اصلی (Core Business Logic) طراحی شده است. فاز بعدی پروژه باید بر پیاده‌سازی کامل لایه API (کنترلرها و مسیرها) و سپس توسعه تست‌های خودکار متمرکز شود تا از پایداری و صحت عملکرد سیستم اطمینان حاصل گردد. معماری فعلی، توسعه و افزودن قابلیت‌های جدید در آینده را به شکل قابل توجهی تسهیل می‌کند.

---
**پایان سند**
